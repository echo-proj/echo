name: Deploy to Cloud Run

on:
  workflow_dispatch:

env:
  GCP_PROJECT_ID: echo-project-481417
  GCP_REGION: us-central1

  jobs:
    detect-changes:
      name: Detect Changes
      runs-on: ubuntu-latest
      if: false
      outputs:
        backend: ${{ steps.filter.outputs.backend }}
        collab: ${{ steps.filter.outputs.collab }}
        frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            collab:
              - 'collaboration-service/**'
            frontend:
              - 'frontend/**'

  deploy-backend:
    name: Deploy Spring Backend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Build and push Docker image
        run: |
          cd backend
          gcloud builds submit --tag gcr.io/${{ env.GCP_PROJECT_ID }}/echo-backend

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy echo-backend \
            --image gcr.io/${{ env.GCP_PROJECT_ID }}/echo-backend \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --set-env-vars="SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }},SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }},SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }},JWT_SECRET=${{ secrets.JWT_SECRET }},JWT_EXPIRATION=${{ secrets.JWT_EXPIRATION }},APP_CORS_ALLOWED_ORIGINS=${{ secrets.APP_CORS_ALLOWED_ORIGINS }}"

  deploy-collab:
    name: Deploy Collaboration Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Build and push Docker image
        run: |
          cd collaboration-service
          gcloud builds submit --tag gcr.io/${{ env.GCP_PROJECT_ID }}/echo-collab

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy echo-collab \
            --image gcr.io/${{ env.GCP_PROJECT_ID }}/echo-collab \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --set-env-vars="SPRING_BOOT_URL=https://echo-backend-204368275126.us-central1.run.app"

  deploy-frontend:
    name: Deploy Next.js Frontend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Build and push Docker image
        run: |
          cd frontend
          gcloud builds submit --config cloudbuild.yaml \
            --substitutions=_NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL }}",_NEXT_PUBLIC_WS_URL="${{ secrets.NEXT_PUBLIC_WS_URL }}"

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy echo-frontend \
            --image gcr.io/${{ env.GCP_PROJECT_ID }}/echo-frontend \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --allow-unauthenticated \
            --set-env-vars="NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }},NEXT_PUBLIC_WS_URL=${{ secrets.NEXT_PUBLIC_WS_URL }}"
